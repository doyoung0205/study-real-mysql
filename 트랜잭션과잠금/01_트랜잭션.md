### 트랜잭션과 잠금

## 엔진 별 트랜잭션 차이

- MyISAM 이나 MEMORY 스토리지 엔진이 더 빠르지만 트랜잭션을 지원하지 않는다.
- INNODB 는 트랜잭션을 지원한다.

```mysql

# MyISAM, INNODB 각각 PK의 3이라는 데이터 입력
CREATE TABLE tab_myisam
(
    fdpk INT NOT NULL,
    PRIMARY KEY (fdpk)
) ENGINE = MyISAM;
INSERT INTO tab_myisam (fdpk)
values (3);

CREATE TABLE tab_innodb
(
    fdpk INT NOT NULL,
    PRIMARY KEY (fdpk)
) ENGINE = INNODB;
INSERT INTO tab_innodb (fdpk)
values (3);


SET autocommit = ON;

INSERT INTO tab_myisam (fdpk)
values (1),
       (2),
       (3);
INSERT INTO tab_innodb (fdpk)
values (1),
       (2),
       (3);


select *
from tab_myisam; # 1,2,3 존재

select *
from tab_innodb; # 3 만 존재

```

- InnoDB는 쿼리 중 일부라도 오류를 발생하면 전체를 원 상태로 만든다는 트랜잭션의 원칙대로 INSERT 문장을 실행하기 전 상태로 그대로 복구함
- MyISAM은 부분 업데이트(Partial Update) 현상이 발생 -> 데이터의 정합성을 맞추는데 상당히 어려운 문제

---

## 트랜잭션 주의사항

- 트랜잭션의 범위를 최소화 하라

일반적으로 데이터베이스 커넥션은 개수가 제한적이어서 각 단위 프로그램이 커넥션을 소유하는 시간이 길어질수록 사용 가능 여유 커넥션의 갯수가 줄어든다.

그리고 어느순간 각 단위 프로그램에서 커넥션을 가져가기 위해 기다려야 하는 상황이 발생할 수 있다.

### 예시

1. 처리시작
    - ==> 데이터베이스 커넥션 생성
    - ==> 트랜잭션 시작
2. 사용자의 로그인 여부 확인
3. 사용자의 글쓰기 내용의 오류 여부 확인
4. 첨부로 업로드된 파일 확인 및 저장
5. 사용자의 입력 내용을 DBMS에 저장
6. 첨부 파일 정보를 DBMS에 저장
7. 저장된 내용 또는 기타 정보를 DBMS에서 조회
8. 게시물 등록에 대한 알림 메일 발송
9. 알림 메일 발송 이력을 DBMS에 저장
    - <== 트랜잭션 종료(commit)
    - <== 데이터베이스 커넥션 반납
10. 처리완료

### 예시의 문제점

- 실제로 DMBS에 저장하는 건 5번 부터이다.
- 8번은 트랜잭션 범위에 있으면 위험하다.
    - 메일 전송이나 FTP 또는 네트워크를 통해 원격 서버와 통신하는 등과 같은 작업은 어떻게 해서든 DBMS의 트랜잭션 내에서 제거하는 것이 좋다.
    - 프로그램이 실행되는 동안 메일 서버와 통신할 수 없는 상황이 발생한다면 웹 서버 뿐만 아니라 DBMS 서버 까지 위험해지는 상황이 발생할 것 이다.
- 작업의 목적에 따라 나눌 필요가 있다.
    - 5,6 번은 사용자가 입력한 정보를 저장하는 트랜잭션
    - 7번은 데이터 단순 확인 및 조회임으로 트랜잭션이 필요없다.
    - 9번은 작업도 5,6번과는 성격이 다르기 때문에 분리

### 예시 개선

1. 처리시작
2. 사용자의 로그인 여부 확인
3. 사용자의 글쓰기 내용의 오류 여부 확인
4. 첨부로 업로드된 파일 확인 및 저장
    - ==> 데이터베이스 커넥션 생성
    - ==> 트랜잭션 시작
5. 사용자의 입력 내용을 DBMS에 저장
6. 첨부 파일 정보를 DBMS에 저장
    - <== 트랜잭션 종료(commit)
7. 저장된 내용 또는 기타 정보를 DBMS에서 조회
8. 게시물 등록에 대한 알림 메일 발송
    - ==> 트랜잭션 시작
9. 알림 메일 발송 이력을 DBMS에 저장
    - <== 트랜잭션 종료(commit)
    - <== 데이터베이스 커넥션 반납
10. 처리완료

### 네트워크 작업이 한두줄 있더라도 꼭 트랜잭션에서 배제하자.
